pipeline {
    agent { docker { image 'python:3.8' } }
    stages {
        stage('build') {
            steps {
                withEnv(["HOME=$env.WORKSPACE"]){
                    sh 'pip install --user -r requirements.txt'
                }
            }
        }
        stage('test') {
            steps {
                withEnv(["HOME=$env.WORKSPACE","TERM='linux'"]){
                    sh 'python -m pylint --rcfile=testing/pylint.cfg $(find . -maxdepth 1 -name "*.py" -print) ./ > pylint.log || exit 0'
                    sh 'python -m pytest --cov=./ --verbose --cov-fail-under=97 --junit-xml test-results/results.xml ./testing/'
                    sh 'python -m coverage xml'
                }
            }
        }
    }
    post {
            always {
                junit 'test-results/results.xml'
                step([$class: 'CoberturaPublisher', autoUpdateHealth: false, autoUpdateStability: false, coberturaReportFile: 'coverage.xml', failUnhealthy: false, failUnstable: false, maxNumberOfBuilds: 0, onlyStable: false, sourceEncoding: 'ASCII', zoomCoverageChart: false])
                sh 'rm .local -rf'
            }
    }
}
